---
title: "MS_for_proteomics_tutorial"
author: "Sam Siljee"
date: "24/05/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
#Install Spectra using BiocManager
library("Spectra")
library("rpx")
library("mzR")
```
## Starting with Spectra
```{r starting with spectra, include=FALSE}
# first part of MS data
spd <- DataFrame(msLevel = c(1L, 2L),
          rtime = c(10.1, 24))
spd

#still requires raw data to be more like MS data. Use list

spd$mz <- list(c(100, 103.2, 104.3, 106.5),
     c(45.6, 120.4, 190.2))

spd$intensity <- list(c(200, 400, 34.2, 17),
     c(12.3, 15.2, 6.8))

spd

#simple dataframe set up, nothing specific to MS yet. Now we can use the `Spectra` package to convert generic dataframe to object specific to MS

sp <- Spectra(spd)

#sp is an object of class "Spectra" which is specific to MS datasets
sp

#As can be seen, most of the variables are not populated
spectraVariables(sp)

#The values of these variables can be accessed
spectraData(sp)

# as well as individual spectra
peaksData(sp)

peaksData(sp)[[1]]
```

## Getting raw MS data from a public repository
```{r getting raw MS data from a public repository, include=FALSE}
#The following code from the tutorial does not run, likely due to server issues with the repository. I have commented it out for now, downloaded the datasets separately, and loaded them from there. Note that the dataset is too large to load to github, so I have added it to the gitignore


#px1 <- PXDataset("PXD000001")

#`px1` is not a dataset in and of itself, however it is a method to query the EBI database
#px1

#review files in px1, we are interested in #7
#pxfiles(px1)

#create a variable for file #7
#f <- "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01-20141210.mzML"

#download results
#mzf <- pxget(px1, f)

#mzf is path to raw dataset
#mzf

#setting up the actual dataset, using the download approach as described above. Note that this will overwrite the `sp` variable previously defined
sp <- Spectra("~/Coding/MS_for_proteomics_tutorial/data/TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01-20141210.mzML")

#The values of these variables can be accessed, as with the small practice dataset, note that more variables are actually included
spectraVariables(sp)

# as well as individual spectra
peaksData(sp)

peaksData(sp)[[1]]

#check that there are indeed 7434 spectra in this dataset
length(sp)

#look at the first few spectra
spectraData(sp)

#you can use a function to access specific aspects
msLevel(sp)

#table the number of MS1 and MS2 scans
table(msLevel(sp))

#Can also look at retention times
rtime(sp)

#and we can look at the range of retention time, note that the first data point does not have any useful data
range(rtime(sp))

#can also filter by certain variables
sp2 <- filterMsLevel(sp, 2)

sp2

#now to visualise the chromatogram. the `tic` function gives total ion current. the chromatogram only makes sense for MS1 data, so first extract the MS1 only
sp1 <- filterMsLevel(sp, 1)

#get retention times
rtime(sp1)

#get total ion currents
tic(sp1)

#then get the retention times, and ion times and plot them
plot(rtime(sp1), tic(sp1), type = "l")

#can also subset to select a specific spectrum, works like a list
#for example extracting spectrum number 1000, will give a Spectra object of length 1, with the thousandth spectrum
sp[1000]

#Or select scans from 1000 to 2000
sp[1000:2000]

#there is also a function to plot a spectrum, this give the classic m/z vs intensity plot
plotSpectra(sp[1000])

#could also create this plot manually, now that we know how to access this data, as follows
#create a Spectra object of scan number 1000
sp1000 <- sp[1000]

#extract the mz values, this creates a list of length 1, so select the first list
mz(sp1000)[[1]] 

#extract the intensities, as above
intensity(sp1000)[[1]]

#and plot them
plot(mz(sp1000)[[1]],
     intensity(sp1000)[[1]],
     type = "h")


```

